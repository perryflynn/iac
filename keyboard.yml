---
- name: Keyboard experiments
  hosts: all

  environment:
    DEBIAN_FRONTEND: noninteractive

  tasks:

    - apt:
        state: "{{item[0]}}"
        purge: "{{item[1]}}"
        name:
          - keyboard-configuration
          - console-setup
      loop:
        - [ absent, true ]
        - [ present, false ]

    - name: Keyboard config
      copy:
        dest: /etc/default/keyboard
        owner: root
        group: root
        mode: u=rw,go=r
        content: |
          XKBMODEL="pc105"
          XKBLAYOUT="de"
          XKBVARIANT="deadacute"
          XKBOPTIONS="lv3:ralt_switch"
          BACKSPACE="guess"

    - name: Console-Setup config
      copy:
        dest: /etc/default/console-setup
        owner: root
        group: root
        mode: u=rw,go=r
        content: |
          ACTIVE_CONSOLES="/dev/tty[1-6]"
          CHARMAP="UTF-8"
          CODESET="Lat15"
          FONTFACE="VGA"
          FONTSIZE="8x16"
          VIDEOMODE=

    # - name: Set timezone
    #   timezone:
    #     name: "{{timezone}}"

    # - name: Set locale
    #   locale_gen:
    #     name: "{{item}}"
    #   loop: "{{locales}}"

    # - name: Debconf for Ubuntu/Debian systems
    #   debconf:
    #     name: "{{item[0]}}"
    #     question: "{{item[1]}}"
    #     vtype: "{{item[2]}}"
    #     value: "{{item[3]}}"
    #     unseen: false
    #   loop:
    #     - [ 'console-setup', 'console-setup/charmap47', 'select', 'UTF-8' ]
    #     - [ 'console-setup', 'console-setup/codeset47', 'select', '# Latin1 and Latin5 - western Europe and Turkic languages' ]
    #     - [ 'console-setup', 'console-setup/fontface47', 'select', 'VGA' ]
    #     - [ 'console-setup', 'console-setup/fontsize', 'select', '8x16' ]
    #     - [ 'keyboard-configuration', 'keyboard-configuration/altgr', 'select', 'Right Alt (AltGr)' ]
    #     - [ 'keyboard-configuration', 'keyboard-configuration/compose', 'select', 'No compose key' ]
    #     - [ 'keyboard-configuration', 'keyboard-configuration/ctrl_alt_bksp', 'boolean', 'false' ]
    #     - [ 'keyboard-configuration', 'keyboard-configuration/layout', 'select', '{{debconfkeymap}}' ]
    #     - [ 'keyboard-configuration', 'keyboard-configuration/model', 'select', 'Generic 105-key PC' ]
    #     - [ 'keyboard-configuration', 'keyboard-configuration/variant', 'select', '{{debconfkeymapvariant}}' ]
    #     - [ 'locales', 'locales/default_environment_locale', 'select', '{{locale}}' ]
    #     - [ 'locales', 'locales/locales_to_be_generated', 'multiselect', "{{locales|join(' UTF-8, ')}} UTF-8" ]
    #     - [ 'tzdata', 'tzdata/Zones/Etc', 'select', '{{timeregion}}' ]
    #     - [ 'tzdata', 'tzdata/Zones/{{timeregion}}', 'select', '{{timecity}}' ]

    - name: Set selections
      shell:
        chdir: /
        executable: /bin/bash
        cmd: |
          cat > /tmp/keyboard-selections.txt << EOL
          console-setup   console-setup/store_defaults_in_debconf_db      boolean true
          keyboard-configuration  keyboard-configuration/store_defaults_in_debconf_db     boolean true
          EOL

          debconf-set-selections < /tmp/keyboard-selections.txt

    - name: Run dpkg-reconfigure
      shell:
        chdir: /
        executable: /bin/bash
        cmd: 'dpkg-reconfigure {{item}}'
      loop:
        - keyboard-configuration
        - console-setup
      register: reconf

    - debug:
        var: reconf
